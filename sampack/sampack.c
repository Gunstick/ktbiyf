/* Fast Lossy Sound Compression / Decompression       ( DPCM? )
 * This program compresses any 8 bit PCM sound to half the size 
 *
 * Code by Georges Kesseler <georges.kesseler@restena.lu>
 * 
 * This source may be freely used but if it is included in any
 * software blablabla
 *
 */

/* History:
 * original code (c) 1988 Unlimited Matricks (68000 Assembly)
 * 1990 optimisation, realtime operating (36kHz on an 8MHz 68000)
 * 1992 conversion to C
 */

/*
 * Some stories:
 * As this program was first written in assembler the C code is 
 * still assembler oriented (e.g. the tables for speed)
 * Directly converting to C was so difficult that finally the code
 * was entierly rewritten. This shows that some tricks possible in
 * assembler are impossible in C, or does anyone know how to test
 * if in an addition an overflow occured?
 */
#include <stdio.h>
#include <stdlib.h>
#define BYTE unsigned char

/* converter table:
 * IN:   difference of 2 samples
 * OUT:  code for this difference
 */ BYTE bestfit[256]= {
         0x0,0x1,0x2,0x2,0x3,0x3,0x3,0x4,0x4,0x4,0x4,0x4,0x4,0x5,0x5,0x5,
         0x5,0x5,0x5,0x5,0x5,0x5,0x5,0x5,0x5,0x6,0x6,0x6,0x6,0x6,0x6,0x6,
         0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,0x6,
         0x6,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,
         0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,
         0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,
         0x7,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,
         0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,
         0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,
         0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,0x8,
         0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,
         0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,
         0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0x9,0xa,
         0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,
         0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xb,0xb,0xb,0xb,0xb,0xb,0xb,0xb,0xb,
         0xb,0xb,0xb,0xb,0xc,0xc,0xc,0xc,0xc,0xc,0xd,0xd,0xd,0xe,0xe,0xf};

/* decoder table */
 BYTE decodetab[16]={0,1,2,4,8,16,32,64,128,-64,-32,-16,-8,-4,-2,-1};
                                         
int kompress(FILE *in,FILE *out)
{                                         
 BYTE result,code;
 BYTE sample,diff;
 short xact;
 BYTE wert;
 
 if ((xact=fgetc(in))<0) return(1);
 wert=(BYTE)xact;
 fputc(wert,out);
 while (1)
 {                           
    if((xact=fgetc(in))<0) return(2);
	sample=(BYTE)xact;					/* read sample */
	code=bestfit[(BYTE)(sample-wert)];	/* get approx code */
	diff=decodetab[(BYTE)code];			/* get delta value */
	
    xact=sample-(BYTE)(wert+diff);		
	if((xact>128)||(xact<-128))			/* if abs(xact)>128 */
    	if (sample<wert) code++;		/* get better code */
    	            else code--;
	wert+=decodetab[(BYTE)code];		/* calc with definitive code */
	result=code<<4;						/* first nibble */

	if((xact=fgetc(in))<0) return(3);
	sample=(BYTE)xact;
	code=bestfit[(BYTE)(sample-wert)];
	diff=decodetab[(BYTE)code];
	xact=sample-(BYTE)(wert+diff);
    if ((xact>128)||(xact<-128))
    	if (sample<wert) code++;
        			else code--;
	wert+=decodetab[(BYTE)code]; 
	fputc(result+code,out);			/* second nibble */
 }
}


int dekompress(FILE *in,FILE* out)
{
  short code;
  BYTE wert;
  
  if ((code=fgetc(in))<0) return(1);
  wert=(BYTE)code;
  fputc(wert,out);
  while ((code=fgetc(in))>=0)
  {
    wert+=decodetab[code>>4];
    fputc(wert,out);
    wert+=decodetab[code&0xf];
    fputc(wert,out);
  }
  return(2);
}


void error()
{
    fprintf(stderr,"Usage: sampack -d|-k infile outfile\n");
	fprintf(stderr,"Sample packer by Georges.Kesseler@restena.lu\n");
	                
    exit(1);
}

#define KOMPRESS 1
#define DEKOMPRESS 2
int main (int argc, const char *argv[])
{
  FILE *fi,*fo;
  int mode;

  if (argc<4) error();

  if (argv[1][0]!='-') error();
  if (argv[1][1]=='k') mode = KOMPRESS;
  else if (argv[1][1]=='d') mode = DEKOMPRESS;
  else error();

  if((fi=fopen( argv[2], "rb"))!=NULL &&
     (fo=fopen( argv[3], "wb"))!=NULL)
  {
	if(mode==KOMPRESS)
	{
      kompress(fi,fo);
	  fclose(fi);
	  fclose(fo);
    }
    else
	{	
      dekompress(fi,fo);
      fclose (fi);
      fclose (fo);
    }
    
  }
  return(0);
}
